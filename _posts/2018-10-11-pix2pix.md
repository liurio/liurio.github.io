###案例

这个模型是使用了大约2000张猫的图片，以及对应的自动生成的轮廓图片来训练的。 

![cat](img\cat.jpeg)

### 损失函数

pix2pix的损失函数为：

​			$L_{cGAN}(G,D)=E_{x,y}[logD(x,y)]+E_{x,z}[log(1-D(x,G(x,z)))]$

为了做对比，同时再去训练一个普通的GAN，即只让D判断是否为真实图像：

​			$L_{GAN}(G,D)=E_y[logD(y)]+E_{x,z}[log(1-D(G(x,z)))]$

对于图像翻译任务而言，G的输入和输出之间其实共享了很多信息，比如图像上色任务，输入和输出之间就共享了边的信息。因而为了保证输入图像和输出图像之间的相似度。还加入了L1 Loss

​			$L_{L1}(G)=E_{x,y,z}[||y-G(x,z)||_1]$

那么，汇总的损失函数为：

​			$G^*=argmin_Gmax_DL_{cGAN}(G,D)+\lambda L_{L1}(G)$

### 工作原理

pix2pix使用了一种被称为条件生成对抗网络（cGAN）的技术从输入图像到输出图像的映射。整个网络由两部分组成：生成器和判别器。生成器将一些图像变换应用到了输入图像上以得到输出图像。辨别器的任务就是比较输入图像和一个未知的图像（要么是要翻译的目标图像，要么时生成器生成的图像）并判断是不是生成器生成的图像。

#### 生成器

生成器的任务是将输入的图像转变为目标图像。例如：

![](img\生成器.png)

在pix2pix中采用的是编码-解码器架构实现的，如图：

![](img\生成器原理.png)

这里边，很多立方体表达了卷积神经网络的参数张量，旁边的数字是张量的维度。输入图像是256*256大小3种颜色通道的图像（红、绿、蓝通道，对于黑白图，这三个通道的数值相等），而输出则相同。

生成器接收输入，并将它用一系列编码器（卷积+激活函数）简化成更小的表示。这种做法的思想是我们利用最终的编码层可以得到一种对数据更高层次的表达。而解码层，则做相反的工作（反卷积+激活函数），并将编码层的动作反过来。

为了得到图像到图像的转化率，并且如果使用普通的卷积神经网络，那么会导致每一层都承载保存着所有的信息，这样神经网络容易出错，因而使用U-Net来进行减负。以便将编码层和解码层直接相连。所谓的U-Net是将第i层拼接到第n-i层，这样做是因为第i层和第n-i层的图像大小是一致的，可以认为他们承载着类似的信息。 这种跳跃链接可以为网络提供一种省略编码/解码部分的选择，从而提升效率。如图：

![](img\生成器U-Net.png)

#### 判别器

判别器的工作就是要区分输入的图片是由生成器生成的，还是我们想要的目标图。结构如下所式：

![](img\判别器.png)

这个结构看起来很像生成器的编码器部分的网络，但是它们工作起来的作用却不太一样。辨别器输出的是一个30X30的图像，而每一个像素都是0~1的数值，代表了这一部分与目标图像比起来有多像。在pix2pix的执行中，着30X30的图像中的每一个像素都对应着输入图像的70X70个块（**patch**，这些patch会有重叠，因为输入图像的大小是256X256）。这种架构称为“**PatchGAN**”。

PatchGAN的意思是无论生成的图像有多大，将其切分为多个固定大小的patch输入进D进行判断。

好处：

- D的输入变小，训练速度加快
- G本身是全卷积，对图像没有限制，Patch后也没有限制，因此可以增大框架拓展性。

### 训练

训练这个网络需要两步，训练判别器和训练生成器。

要训练判别器，首先让生成器生成一张输出图片，然后让判别器检查“输入/目标图像对”和“输入/输出图像对”，并计算两者之间的真实程度。

根据“输入/目标图像对”和“输入/输出图像对”的分类误差，调整**判别器**的权重。如图：

![](img\训练调整权重判别器.png)

根据判别器的输出调整和生成图片与真实图片的误差，调整**生成器**的权重，如图：

![](img\训练调整权重.png)

当你使用判别器来训练你的生成器时，实际上在通过判别器来计算梯度。然后G和D一起变好，效果也越好。

![](img\git.gif)

### tensorflow代码

代码

```java
https://github.com/liurio/pix2pix-tensorflow
```

数据集地址

```sql
https://people.eecs.berkeley.edu/~tinghuiz/projects/pix2pix/datasets/
```

训练

```java
python main.py --phase train
```

测试

```java
python main.py --phase test
```

结果

```mysql
facedes/index.html
```

### 参考

```JAVA
Pix2Pix-基于GAN的图像翻译 https://blog.csdn.net/stdcoutzyx/article/details/78820728
图片翻译机——GAN的神奇功效 http://www.sohu.com/a/134110704_741733
pix2pix tensorflow试验 https://blog.csdn.net/sparkexpert/article/details/70837669
```













